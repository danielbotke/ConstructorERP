<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
    <h:head>
        <title>Registrar Contrato</title>
    </h:head>
    <ui:composition template="template.xhtml">
        <ui:define name="corpo"  rendered="#{usuarioMB.temPermissao('formContrato')}">
            <h:form id="formContrato">
                <center>
                    <h1>Cadastro de Contratos</h1>
                    <p>&nbsp;</p>
                    <h:panelGrid  columns="8" id="gridContrato">
                        <h:outputLabel for="clientes" value="Cliente(s):"/>
                        <h:panelGroup>
                            <p:inputText  id="clientes" value="#{contratoMB.clientes}" required="true" readonly="true"/>
                            <p:commandButton update=":formContrato:clientesDialog" oncomplete="PF('clientesDialog').show()" icon="ui-icon-search" title="Selecionar cliente(s)" />
                        </h:panelGroup>
                        <p:message for="clientes" />


                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                        <h:outputLabel for="aptos" value="Unidade(s):"/>
                        <h:panelGroup>
                            <p:inputText id="aptos" value="#{contratoMB.aptos}" required="true" readonly="true"/>
                            <p:commandButton update=":formContrato:aptosDialog" oncomplete="PF('aptosDialog').show()" icon="ui-icon-search" title="Selecionar apartamento(s)" />
                        </h:panelGroup>
                        <p:message for="aptos" />

                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                        <h:outputLabel for="vagas" value="Vaga(s):"/>
                        <h:panelGroup>
                            <p:inputText id="vagas" value="#{contratoMB.vagas}" required="true" readonly="true"/>
                            <p:commandButton update=":formContrato:vagasDialog" oncomplete="PF('vagasDialog').show()" icon="ui-icon-search" title="Selecionar vaga(s)" />
                        </h:panelGroup>
                        <p:message for="vagas" />

                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                        <h:outputLabel for="dataContrato"  value="Data fechamento:"/>                    
                        <p:calendar styleClass="calendar" id="dataContrato" locale="pt" pattern="dd/MM/yyyy" navigator="true" value="#{contratoMB.bean.dataContrato}"
                                    mode="popup" showOn="button" required="true" immediate="true">
                        </p:calendar>
                        <p:message for="dataContrato" />

                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                        <h:outputLabel for="vlContrato" value="Valor total negociado:"/>
                        <h:inputText class="inputText" id="vlContrato" value="#{contratoMB.bean.valorTotal}" required="true" converter="convertFloat" immediate="true">
                            <f:convertNumber locale="pt_BR"  maxFractionDigits="4"/> 
                        </h:inputText>
                        <p:message for="vlContrato" />

                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                       
                        <h:outputLabel for="codigo" value="Código:" style="visibility: hidden"/>
                        <h:inputText style="visibility: hidden" class="inputText" id="codigo" value="#{contratoMB.bean.id}" required="true" immediate="true" />
                        <p:message for="codigo" style="visibility: hidden"/>

                        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>

                    </h:panelGrid>

                    <h:commandButton styleClass="button" value="Salvar Contrato" action="#{contratoMB.salvar}"/>
                </center>
                <p:dialog id="aptosDialog" header="Selecione um apartamento" widgetVar="aptosDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false">
                    <h:outputLabel for="predios" value="Predio:"/>
                    <p:selectOneMenu styleClass="selectOnMenu" id="predios" value="#{apartamentoContratoMB.predioSelecionado}" >
                        <p:ajax update="blocos" listener="#{apartamentoContratoMB.onPredioSelecionado}" event="change"/>
                        <f:selectItem itemLabel="Selecione um prédio" itemValue="#{null}"/>  
                        <f:selectItems value="#{predioMB.predios}" var="predio" itemValue="#{predio}" itemLabel="#{predio.name}"/>
                    </p:selectOneMenu>
                    <p:message for="predios" />

                    <h:outputLabel for="blocos" value="Bloco:"/>
                    <p:selectOneMenu styleClass="selectOnMenu" id="blocos" value="#{apartamentoContratoMB.blocoSelecionado}" >
                        <p:ajax event="change" update="aptosDT" />
                        <f:selectItem itemLabel="Selecione um bloco" itemValue="#{null}"/> 
                        <f:selectItems value="#{apartamentoContratoMB.blocosPredio}" var="bloco" itemValue="#{bloco}" itemLabel="#{bloco.identificacao}"/>
                    </p:selectOneMenu>
                    <p:message for="blocos" />
                    <p:dataTable id="aptosDT" var="apto" value="#{apartamentoContratoMB.apartamentosBlocoNaoVendidos}" selection="#{contratoMB.apartamentosSelecionados}" rowKey="#{apto.id}"
                                 paginatorTemplate=" {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                                 paginator="true" rows="10" style="margin-bottom:20px">
                        <f:facet name="header">
                            Selecione um apartamento
                        </f:facet>
                        <p:column selectionMode="multiple" style="width:16px;text-align:center"/>
                        <p:column headerText="Predio">
                            <h:outputText value="#{apto.bloco.predio.name}" />
                        </p:column>
                        <p:column headerText="Bloco">
                            <h:outputText value="#{apto.bloco.identificacao}" />
                        </p:column>
                        <p:column headerText="Unidade">
                            <h:outputText value="#{apto.name}" />
                        </p:column>
                        <p:column headerText="[Area total">
                            <h:outputText value="#{apto.areaTotal}" />
                        </p:column>
                        <f:facet name="footer">
                            <p:commandButton process="aptosDT" icon="ui-icon-check" value="Selecionar" oncomplete="PF('aptosDialog').hide()" update=":formContrato:aptos" />
                        </f:facet>
                    </p:dataTable>
                </p:dialog>
                <p:dialog id="vagasDialog" header="Selecione uma vaga" widgetVar="vagasDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false">
                    <h:outputLabel for="prediosVaga" value="Predio:"/>
                    <p:selectOneMenu styleClass="selectOnMenu" id="prediosVaga" value="#{vagaContratoMB.predioSelecionado}" >
                        <p:ajax event="change" update="vagaDT" />
                        <f:selectItem itemLabel="Selecione um prédio" itemValue="#{null}"/>  
                        <f:selectItems value="#{predioMB.predios}" var="predio" itemValue="#{predio}" itemLabel="#{predio.name}"/>
                    </p:selectOneMenu>
                    <p:message for="prediosVaga" />

                    <p:dataTable id="vagaDT" var="vag" value="#{vagaContratoMB.vagasPredioDisponiveis}" selection="#{contratoMB.vagasSelecionadas}" rowKey="#{vag.id}"
                                 paginatorTemplate=" {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                                 paginator="true" rows="10" style="margin-bottom:20px">
                        <f:facet name="header">
                            Selecione as vagas
                        </f:facet>
                        <p:column selectionMode="multiple" style="width:16px;text-align:center"/>
                        <p:column headerText="Predio">
                            <h:outputText value="#{vag.predio.name}" />
                        </p:column>

                        <p:column headerText="Vaga" >
                            <h:outputText value="#{vag.name}" />
                        </p:column>

                        <p:column headerText="m²" >
                            <h:outputText value="#{vag.m2}" />
                        </p:column>

                        <p:column headerText="Vendido" >
                            <h:outputText value="#{vag.vendido}" />
                        </p:column>
                        <f:facet name="footer">
                            <p:commandButton process="vagaDT" icon="ui-icon-check" value="Selecionar" oncomplete="PF('vagasDialog').hide()" update=":formContrato:vagas" />
                        </f:facet>
                    </p:dataTable>
                </p:dialog>
                <p:dialog id="clientesDialog" header="Selecione o(s) cliente(s)" widgetVar="clientesDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false" >
                    <p:dataTable id="clientesDT" var="c" value="#{clienteMB.clientes}" selection="#{contratoMB.clientesSelecionados}" rowKey="#{c.id}"
                                 paginatorTemplate=" {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                                 paginator="true" rows="10" style="margin-bottom:20px">
                        <f:facet name="header">
                            Selecione o(s) cliente(s)
                        </f:facet>
                        <p:column selectionMode="multiple" style="width:16px;text-align:center"/>
                        <p:column headerText="Nome">
                            <h:outputText value="#{c.pessoa.name}" />
                        </p:column>
                        <p:column headerText="Cidade">
                            <h:outputText value="#{c.pessoa.cidade.name} - #{c.pessoa.cidade.estado.sigla}" />
                        </p:column>
                        <p:column headerText="E-mail">
                            <h:outputText value="#{c.pessoa.email}" />
                        </p:column>
                        <f:facet name="footer">
                            <p:commandButton process="clientesDT" icon="ui-icon-check" value="Selecionar" oncomplete="PF('clientesDialog').hide()" update=":formContrato:clientes"/>
                        </f:facet>
                    </p:dataTable>
                </p:dialog>
            </h:form>

            <h:form id="formDataContrato">
                <p:dataTable id="tblContratos" var="contrato" value="#{contratoMB.contratos}" paginatorTemplate=" {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {Exporters}"
                             paginator="true" rows="10" style="margin-bottom:20px" sortMode="multiple">
                    <f:facet name="{Exporters}">
                        <h:commandLink>
                            <p:graphicImage value="../resources/images/excel.png" width="24"/>
                            <p:dataExporter type="xls" target="tblContratos" fileName="Contratos" />
                        </h:commandLink>
                    </f:facet>
                    <p:column headerText="Código" sortBy="#{contrato.id}">
                        <h:outputText value="#{contrato.id}" />
                    </p:column>

                    <p:column headerText="Cliente" sortBy="#{contrato.nomePrimeiroCliente()}">
                        <h:outputText value="#{contrato.nomePrimeiroCliente()}" />
                    </p:column>

                    <p:column headerText="Unidade"  sortBy="#{contrato.apartamentosDesc()}">
                        <h:outputText value="#{contrato.apartamentosDesc()}" />
                    </p:column>

                    <p:column headerText="Valor total" sortBy="#{contrato.valorTotal}">
                        <h:outputText value="#{contrato.valorTotal}" >
                            <f:convertNumber locale="pt_BR" maxFractionDigits="4"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Data Contrato" sortBy="#{contrato.dataContrato}">
                        <h:outputText value="#{contrato.dataContrato}">
                            <f:convertDateTime type="date" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Situação" sortBy="#{contrato.status}">
                        <h:outputText value="#{contrato.status == 0 ? 'Em andamento': ''}" />
                        <h:outputText value="#{contrato.status == 1 ? 'Finalizado': ''}"/>
                        <h:outputText value="#{contrato.status == 2 ? 'Distratado': ''}" />
                    </p:column>

                    <p:column style="width:24px">
                        <p:commandLink title="Edit" styleClass="ui-icon ui-icon-pencil" action="#{contratoMB.editar(contrato)}" ajax="false">
                            <f:param name="contract" value="#{contrato.id}"/> 
                        </p:commandLink>
                    </p:column>
                    <p:column style="width:24px" >
                        <p:commandLink title="Excluir" styleClass="ui-icon ui-icon-trash" action="#{contratoMB.deletar(contrato)}" ajax="false">
                            <p:confirm header="Confirmação" message="Tem certeza que deseja excluir este contrato?" icon="ui-icon-alert" />
                        </p:commandLink>
                        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                            <p:commandButton value="Sim" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                            <p:commandButton value="Não" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                        </p:confirmDialog>
                    </p:column>
                    <p:column style="width:24px" >
                        <p:commandLink title="Distrato" styleClass="ui-icon ui-icon-cancel" actionListener="#{contratoMB.selecionarContract(contrato.id)}" oncomplete="PF('distratoDialog').show()">
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
                <p:dialog id="distratoDialog" header="Motivo do distrato" widgetVar="distratoDialog" modal="true" showEffect="fade" hideEffect="fade">
                    <h:outputText value="Tem certeza que deseja realizar o distrato este contrato? Isto fará com que todas as parcelas ainda abertas ligadas a este contrato sejam canceladas, e o imóvel liberado."/>
                    <br/>
                    <h:outputLabel for="motivoDistrato" value="Informe o motivo do distato:"/>
                    <p:inputTextarea id="motivoDistrato" value="#{contratoMB.motivoDistrato}" />
                    <p:message for="motivoDistrato" />

                    <h:commandButton value="Distratar" action="#{contratoMB.distrato}" />
                    <h:commandButton value="Calcelar" onclick="distratoDialog.hide()" />
                </p:dialog>
            </h:form>

        </ui:define>
    </ui:composition>
</html>

